!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("ot-es",[],t):"object"==typeof exports?exports["ot-es"]=t():e["ot-es"]=t()}("undefined"!=typeof self?self:this,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t,n){"use strict";var r,i="object"==typeof Reflect?Reflect:null,o=i&&"function"==typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};r=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var u=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function f(e,t,n,r){var i,o,s,a;if(c(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(i=l(e))>0&&s.length>i&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,a=u,console&&console.warn&&console.warn(a)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=h.bind(r);return i.listener=n,r.wrapFn=i,i}function v(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):d(i,i.length)}function y(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function d(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");u=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var u=i[e];if(void 0===u)return!1;if("function"==typeof u)o(u,this,t);else{var c=u.length,l=d(u,c);for(n=0;n<c;++n)o(l[n],this,t)}return!0},a.prototype.addListener=function(e,t){return f(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return f(this,e,t,!0)},a.prototype.once=function(e,t){return c(t),this.on(e,p(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,p(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,r,i,o,s;if(c(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},a.prototype.listeners=function(e){return v(this,e,!0)},a.prototype.rawListeners=function(e){return v(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):y.call(e,t)},a.prototype.listenerCount=y,a.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t,n){(function(e){var r=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),n={},r=0;r<t.length;r++)n[t[r]]=Object.getOwnPropertyDescriptor(e,t[r]);return n},i=/%[sdj%]/g;t.format=function(e){if(!g(e)){for(var t=[],n=0;n<arguments.length;n++)t.push(a(arguments[n]));return t.join(" ")}n=1;for(var r=arguments,o=r.length,s=String(e).replace(i,(function(e){if("%%"===e)return"%";if(n>=o)return e;switch(e){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(e){return"[Circular]"}default:return e}})),u=r[n];n<o;u=r[++n])y(u)||!w(u)?s+=" "+u:s+=" "+a(u);return s},t.deprecate=function(n,r){if(void 0!==e&&!0===e.noDeprecation)return n;if(void 0===e)return function(){return t.deprecate(n,r).apply(this,arguments)};var i=!1;return function(){if(!i){if(e.throwDeprecation)throw new Error(r);e.traceDeprecation?console.trace(r):console.error(r),i=!0}return n.apply(this,arguments)}};var o,s={};function a(e,n){var r={seen:[],stylize:c};return arguments.length>=3&&(r.depth=arguments[2]),arguments.length>=4&&(r.colors=arguments[3]),v(n)?r.showHidden=n:n&&t._extend(r,n),m(r.showHidden)&&(r.showHidden=!1),m(r.depth)&&(r.depth=2),m(r.colors)&&(r.colors=!1),m(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=u),l(r,e,r.depth)}function u(e,t){var n=a.styles[t];return n?"["+a.colors[n][0]+"m"+e+"["+a.colors[n][1]+"m":e}function c(e,t){return e}function l(e,n,r){if(e.customInspect&&n&&S(n.inspect)&&n.inspect!==t.inspect&&(!n.constructor||n.constructor.prototype!==n)){var i=n.inspect(r,e);return g(i)||(i=l(e,i,r)),i}var o=function(e,t){if(m(t))return e.stylize("undefined","undefined");if(g(t)){var n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(n,"string")}if(d(t))return e.stylize(""+t,"number");if(v(t))return e.stylize(""+t,"boolean");if(y(t))return e.stylize("null","null")}(e,n);if(o)return o;var s=Object.keys(n),a=function(e){var t={};return e.forEach((function(e,n){t[e]=!0})),t}(s);if(e.showHidden&&(s=Object.getOwnPropertyNames(n)),O(n)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return f(n);if(0===s.length){if(S(n)){var u=n.name?": "+n.name:"";return e.stylize("[Function"+u+"]","special")}if(b(n))return e.stylize(RegExp.prototype.toString.call(n),"regexp");if(k(n))return e.stylize(Date.prototype.toString.call(n),"date");if(O(n))return f(n)}var c,w="",C=!1,j=["{","}"];(p(n)&&(C=!0,j=["[","]"]),S(n))&&(w=" [Function"+(n.name?": "+n.name:"")+"]");return b(n)&&(w=" "+RegExp.prototype.toString.call(n)),k(n)&&(w=" "+Date.prototype.toUTCString.call(n)),O(n)&&(w=" "+f(n)),0!==s.length||C&&0!=n.length?r<0?b(n)?e.stylize(RegExp.prototype.toString.call(n),"regexp"):e.stylize("[Object]","special"):(e.seen.push(n),c=C?function(e,t,n,r,i){for(var o=[],s=0,a=t.length;s<a;++s)E(t,String(s))?o.push(h(e,t,n,r,String(s),!0)):o.push("");return i.forEach((function(i){i.match(/^\d+$/)||o.push(h(e,t,n,r,i,!0))})),o}(e,n,r,a,s):s.map((function(t){return h(e,n,r,a,t,C)})),e.seen.pop(),function(e,t,n){if(e.reduce((function(e,t){return t.indexOf("\n")>=0&&0,e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60)return n[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+n[1];return n[0]+t+" "+e.join(", ")+" "+n[1]}(c,w,j)):j[0]+w+j[1]}function f(e){return"["+Error.prototype.toString.call(e)+"]"}function h(e,t,n,r,i,o){var s,a,u;if((u=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]}).get?a=u.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):u.set&&(a=e.stylize("[Setter]","special")),E(r,i)||(s="["+i+"]"),a||(e.seen.indexOf(u.value)<0?(a=y(n)?l(e,u.value,null):l(e,u.value,n-1)).indexOf("\n")>-1&&(a=o?a.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+a.split("\n").map((function(e){return"   "+e})).join("\n")):a=e.stylize("[Circular]","special")),m(s)){if(o&&i.match(/^\d+$/))return a;(s=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+a}function p(e){return Array.isArray(e)}function v(e){return"boolean"==typeof e}function y(e){return null===e}function d(e){return"number"==typeof e}function g(e){return"string"==typeof e}function m(e){return void 0===e}function b(e){return w(e)&&"[object RegExp]"===C(e)}function w(e){return"object"==typeof e&&null!==e}function k(e){return w(e)&&"[object Date]"===C(e)}function O(e){return w(e)&&("[object Error]"===C(e)||e instanceof Error)}function S(e){return"function"==typeof e}function C(e){return Object.prototype.toString.call(e)}function j(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(n){if(m(o)&&(o=e.env.NODE_DEBUG||""),n=n.toUpperCase(),!s[n])if(new RegExp("\\b"+n+"\\b","i").test(o)){var r=e.pid;s[n]=function(){var e=t.format.apply(t,arguments);console.error("%s %d: %s",n,r,e)}}else s[n]=function(){};return s[n]},t.inspect=a,a.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},a.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.isArray=p,t.isBoolean=v,t.isNull=y,t.isNullOrUndefined=function(e){return null==e},t.isNumber=d,t.isString=g,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=m,t.isRegExp=b,t.isObject=w,t.isDate=k,t.isError=O,t.isFunction=S,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=n(3);var x=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function _(){var e=new Date,t=[j(e.getHours()),j(e.getMinutes()),j(e.getSeconds())].join(":");return[e.getDate(),x[e.getMonth()],t].join(" ")}function E(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){console.log("%s - %s",_(),t.format.apply(t,arguments))},t.inherits=n(4),t._extend=function(e,t){if(!t||!w(t))return e;for(var n=Object.keys(t),r=n.length;r--;)e[n[r]]=t[n[r]];return e};var L="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function P(e,t){if(!e){var n=new Error("Promise was rejected with a falsy value");n.reason=e,e=n}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(L&&e[L]){var t;if("function"!=typeof(t=e[L]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,L,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,n,r=new Promise((function(e,r){t=e,n=r})),i=[],o=0;o<arguments.length;o++)i.push(arguments[o]);i.push((function(e,r){e?n(e):t(r)}));try{e.apply(this,i)}catch(e){n(e)}return r}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),L&&Object.defineProperty(t,L,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,r(e))},t.promisify.custom=L,t.callbackify=function(t){if("function"!=typeof t)throw new TypeError('The "original" argument must be of type Function');function n(){for(var n=[],r=0;r<arguments.length;r++)n.push(arguments[r]);var i=n.pop();if("function"!=typeof i)throw new TypeError("The last argument must be of type Function");var o=this,s=function(){return i.apply(o,arguments)};t.apply(this,n).then((function(t){e.nextTick(s,null,t)}),(function(t){e.nextTick(P,t,s)}))}return Object.setPrototypeOf(n,Object.getPrototypeOf(t)),Object.defineProperties(n,r(t)),n}}).call(this,n(2))},function(e,t){var n,r,i=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var u,c=[],l=!1,f=-1;function h(){l&&u&&(l=!1,u.length?c=u.concat(c):f=-1,c.length&&p())}function p(){if(!l){var e=a(h);l=!0;for(var t=c.length;t;){for(u=c,c=[];++f<t;)u&&u[f].run();f=-1,t=c.length}u=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function v(e,t){this.fun=e,this.array=t}function y(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new v(e,t)),1!==c.length||l||a(p)},v.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=y,i.addListener=y,i.once=y,i.off=y,i.removeListener=y,i.removeAllListeners=y,i.emit=y,i.prependListener=y,i.prependOnceListener=y,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t){e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},function(e,t){"function"==typeof Object.create?e.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:e.exports=function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.r(t),n.d(t,"TextOperation",(function(){return u})),n.d(t,"SimpleTextOperation",(function(){return g})),n.d(t,"WrappedOperation",(function(){return S})),n.d(t,"Selection",(function(){return L})),n.d(t,"toOperation",(function(){return P})),n.d(t,"fromOperation",(function(){return T})),n.d(t,"AjaxAdapter",(function(){return A})),n.d(t,"Client",(function(){return q})),n.d(t,"CodeMirrorAdapter",(function(){return Z})),n.d(t,"SocketIOAdapter",(function(){return X})),n.d(t,"EditorClient",(function(){return fe})),n.d(t,"UndoManager",(function(){return ee})),n.d(t,"Server",(function(){return me})),n.d(t,"EditorSocketIOServer",(function(){return Ce}));var o=function(e){return"number"==typeof e&&e>0},s=function(e){return"string"==typeof e},a=function(e){return"number"==typeof e&&e<0},u=function(){function e(){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!this||this.constructor!==e)return new e;this.ops=[],this.baseLength=0,this.targetLength=0}var t,n,i;return t=e,(n=[{key:"equals",value:function(e){if(this.baseLength!==e.baseLength)return!1;if(this.targetLength!==e.targetLength)return!1;if(this.ops.length!==e.ops.length)return!1;for(var t=0;t<this.ops.length;t++)if(this.ops[t]!==e.ops[t])return!1;return!0}},{key:"retain",value:function(e){if("number"!=typeof e)throw new Error("retain expects an integer");return 0===e||(this.baseLength+=e,this.targetLength+=e,o(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=e:this.ops.push(e)),this}},{key:"insert",value:function(e){if("string"!=typeof e)throw new Error("insert expects a string");if(""===e)return this;this.targetLength+=e.length;var t=this.ops;return s(t[t.length-1])?t[t.length-1]+=e:a(t[t.length-1])?s(t[t.length-2])?t[t.length-2]+=e:(t[t.length]=t[t.length-1],t[t.length-2]=e):t.push(e),this}},{key:"delete",value:function(e){if("string"==typeof e&&(e=e.length),"number"!=typeof e)throw new Error("delete expects an integer or a string");return 0===e||(e>0&&(e=-e),this.baseLength-=e,a(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=e:this.ops.push(e)),this}},{key:"isNoop",value:function(){return 0===this.ops.length||1===this.ops.length&&o(this.ops[0])}},{key:"toString",value:function(){return(Array.prototype.map||function(e){for(var t=[],n=0,r=this.length;n<r;n++)t[n]=e(this[n]);return t}).call(this.ops,(function(e){return o(e)?"retain "+e:s(e)?"insert '"+e+"'":"delete "+-e})).join(", ")}},{key:"toJSON",value:function(){return this.ops}},{key:"apply",value:function(e){if(e.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var t=[],n=0,r=0,i=this.ops,a=0,u=i.length;a<u;a++){var c=i[a];if(o(c)){if(r+c>e.length)throw new Error("Operation can't retain more characters than are left in the string.");t[n++]=e.slice(r,r+c),r+=c}else s(c)?t[n++]=c:r-=c}if(r!==e.length)throw new Error("The operation didn't operate on the whole string.");return t.join("")}},{key:"invert",value:function(t){for(var n=0,r=new e,i=this.ops,a=0,u=i.length;a<u;a++){var c=i[a];o(c)?(r.retain(c),n+=c):s(c)?r.delete(c.length):(r.insert(t.slice(n,n-c)),n-=c)}return r}},{key:"compose",value:function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var n=new e,r=this.ops,i=t.ops,u=0,c=0,l=r[u++],f=i[c++];void 0!==l||void 0!==f;)if(a(l))n.delete(l),l=r[u++];else if(s(f))n.insert(f),f=i[c++];else{if(void 0===l)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===f)throw new Error("Cannot compose operations: first operation is too long.");if(o(l)&&o(f))l>f?(n.retain(f),l-=f,f=i[c++]):l===f?(n.retain(l),l=r[u++],f=i[c++]):(n.retain(l),f-=l,l=r[u++]);else if(s(l)&&a(f))l.length>-f?(l=l.slice(-f),f=i[c++]):l.length===-f?(l=r[u++],f=i[c++]):(f+=l.length,l=r[u++]);else if(s(l)&&o(f))l.length>f?(n.insert(l.slice(0,f)),l=l.slice(f),f=i[c++]):l.length===f?(n.insert(l),l=r[u++],f=i[c++]):(n.insert(l),f-=l.length,l=r[u++]);else{if(!o(l)||!a(f))throw new Error("This shouldn't happen: op1: "+JSON.stringify(l)+", op2: "+JSON.stringify(f));l>-f?(n.delete(f),l+=f,f=i[c++]):l===-f?(n.delete(f),l=r[u++],f=i[c++]):(n.delete(l),f+=l,l=r[u++])}}return n}},{key:"_getSimpleOp",value:function(t,n){var r=t.ops,i=e.isRetain;switch(r.length){case 1:return r[0];case 2:return i(r[0])?r[1]:i(r[1])?r[0]:null;case 3:if(i(r[0])&&i(r[2]))return r[1]}return null}},{key:"_getStartIndex",value:function(e){return o(e.ops[0])?e.ops[0]:0}},{key:"shouldBeComposedWith",value:function(e){if(this.isNoop()||e.isNoop())return!0;var t=this._getStartIndex(this),n=this._getStartIndex(e),r=this._getSimpleOp(this),i=this._getSimpleOp(e);return!(!r||!i||(s(r)&&s(i)?t+r.length!==n:!a(r)||!a(i)||n-i!==t&&t!==n))}},{key:"shouldBeComposedWithInverted",value:function(e){if(this.isNoop()||e.isNoop())return!0;var t=this._getStartIndex(this),n=this._getStartIndex(e),r=this._getSimpleOp(this),i=this._getSimpleOp(e);return!!(r&&i&&(s(r)&&s(i)?t+r.length===n||t===n:a(r)&&a(i)&&n-i===t))}}])&&r(t.prototype,n),i&&r(t,i),e}();function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function h(e,t,n){return t&&f(e.prototype,t),n&&f(e,n),e}i(u,"isRetain",o),i(u,"isInsert",s),i(u,"isDelete",a),i(u,"fromJSON",(function(e){for(var t=new u,n=0,r=e.length;n<r;n++){var i=e[n];if(o(i))t.retain(i);else if(s(i))t.insert(i);else{if(!a(i))throw new Error("unknown operation: "+JSON.stringify(i));t.delete(i)}}return t})),i(u,"transform",(function(e,t){if(e.baseLength!==t.baseLength)throw new Error("Both operations have to have the same base length");for(var n=new u,r=new u,i=e.ops,c=t.ops,l=0,f=0,h=i[l++],p=c[f++];void 0!==h||void 0!==p;)if(s(h))n.insert(h),r.retain(h.length),h=i[l++];else if(s(p))n.retain(p.length),r.insert(p),p=c[f++];else{if(void 0===h)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===p)throw new Error("Cannot compose operations: first operation is too long.");var v;if(o(h)&&o(p))h>p?(v=p,h-=p,p=c[f++]):h===p?(v=p,h=i[l++],p=c[f++]):(v=h,p-=h,h=i[l++]),n.retain(v),r.retain(v);else if(a(h)&&a(p))-h>-p?(h-=p,p=c[f++]):h===p?(h=i[l++],p=c[f++]):(p-=h,h=i[l++]);else if(a(h)&&o(p))-h>p?(v=p,h+=p,p=c[f++]):-h===p?(v=p,h=i[l++],p=c[f++]):(v=-h,p+=h,h=i[l++]),n.delete(v);else{if(!o(h)||!a(p))throw new Error("The two operations aren't compatible");h>-p?(v=-p,h+=p,p=c[f++]):h===-p?(v=h,h=i[l++],p=c[f++]):(v=h,p+=h,h=i[l++]),r.delete(v)}}return[n,r]}));var p=function(){function e(t,n){l(this,e),this.count=t,this.position=n}return h(e,[{key:"toString",value:function(){return"Delete("+this.count+", "+this.position+")"}},{key:"equals",value:function(t){return t instanceof e&&this.count===t.count&&this.position===t.position}},{key:"apply",value:function(e){return e.slice(0,this.position)+e.slice(this.position+this.count)}}]),e}(),v=function(){function e(t,n){l(this,e),this.str=t,this.position=n}return h(e,[{key:"toString",value:function(){return"Insert("+JSON.stringify(this.str)+", "+this.position+")"}},{key:"equals",value:function(t){return t instanceof e&&this.str===t.str&&this.position===t.position}},{key:"apply",value:function(e){return e.slice(0,this.position)+this.str+e.slice(this.position)}}]),e}(),y=function(){function e(){l(this,e)}return h(e,[{key:"toString",value:function(){return"Noop()"}},{key:"equals",value:function(t){return t instanceof e}},{key:"apply",value:function(e){return e}}]),e}(),d=new y,g=function e(){l(this,e)};function m(e){return(m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}c(g,"Insert",v),c(g,"Delete",p),c(g,"Noop",y),c(g,"transform",(function(e,t){if(e instanceof y||t instanceof y)return[e,t];if(e instanceof v&&t instanceof v)return e.position<t.position||e.position===t.position&&e.str<t.str?[e,new v(t.str,t.position+e.str.length)]:e.position>t.position||e.position===t.position&&e.str>t.str?[new v(e.str,e.position+t.str.length),t]:[d,d];if(e instanceof v&&t instanceof p)return e.position<=t.position?[e,new p(t.count,t.position+e.str.length)]:e.position>=t.position+t.count?[new v(e.str,e.position-t.count),t]:[d,new p(t.count+e.str.length,t.position)];if(e instanceof p&&t instanceof v)return e.position>=t.position?[new p(e.count,e.position+t.str.length),t]:e.position+e.count<=t.position?[e,new v(t.str,t.position-e.count)]:[new p(e.count+t.str.length,e.position),d];if(e instanceof p&&t instanceof p){if(e.position===t.position)return e.count===t.count?[d,d]:e.count<t.count?[d,new p(t.count-e.count,t.position)]:[new p(e.count-t.count,e.position),d];if(e.position<t.position)return e.position+e.count<=t.position?[e,new p(t.count,t.position-e.count)]:e.position+e.count>=t.position+t.count?[new p(e.count-t.count,e.position),d]:[new p(t.position-e.position,e.position),new p(t.position+t.count-(e.position+e.count),e.position)];if(e.position>t.position)return e.position>=t.position+t.count?[new p(e.count,e.position-t.count),t]:e.position+e.count<=t.position+t.count?[d,new p(t.count-e.count,t.position)]:[new p(e.position+e.count-(t.position+t.count),t.position),new p(e.position-t.position,t.position)]}})),c(g,"fromTextOperation",(function(e){for(var t=[],n=0,r=0;r<e.ops.length;r++){var i=e.ops[r];u.isRetain(i)?n+=i:u.isInsert(i)?(t.push(new v(i,n)),n+=i.length):t.push(new p(Math.abs(i),n))}return t}));var w,k,O,S=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.wrapped=t,this.meta=n}var t,n,r;return t=e,(n=[{key:"apply",value:function(){return this.wrapped.apply.apply(this.wrapped,arguments)}},{key:"invert",value:function(){var t=this.meta;return new e(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"===m(t)&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)}},{key:"_copy",value:function(e,t){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}},{key:"_composeMeta",value:function(e,t){if(e&&"object"===m(e)){if("function"==typeof e.compose)return e.compose(t);var n={};return this._copy(e,n),this._copy(t,n),n}return t}},{key:"compose",value:function(t){return new e(this.wrapped.compose(t.wrapped),this._composeMeta(this.meta,t.meta))}}])&&b(t.prototype,n),r&&b(t,r),e}();function C(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function j(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function x(e,t,n){return t&&j(e.prototype,t),n&&j(e,n),e}function _(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}O=function(e,t){var n=function(e,t){return e&&"object"===m(e)&&"function"==typeof e.transform?e.transform(t):e},r=(0,e.wrapped.constructor.transform)(e.wrapped,t.wrapped);return[new S(r[0],n(e.meta,t.wrapped)),new S(r[1],n(t.meta,e.wrapped))]},(k="transform")in(w=S)?Object.defineProperty(w,k,{value:O,enumerable:!0,configurable:!0,writable:!0}):w[k]=O;var E=function(){function e(t,n){C(this,e),this.anchor=t,this.head=n}return x(e,[{key:"equals",value:function(e){return this.anchor===e.anchor&&this.head===e.head}},{key:"isEmpty",value:function(){return this.anchor===this.head}},{key:"transform",value:function(t){function n(e){for(var n=e,r=t.ops,i=0,o=t.ops.length;i<o&&(u.isRetain(r[i])?e-=r[i]:u.isInsert(r[i])?n+=r[i].length:(n-=Math.min(e,-r[i]),e+=r[i]),!(e<0));i++);return n}var r=n(this.anchor);return this.anchor===this.head?new e(r,r):new e(r,n(this.head))}}]),e}();_(E,"fromJSON",(function(e){return new E(e.anchor,e.head)}));var L=function(){function e(t){C(this,e),this.ranges=t||[]}return x(e,[{key:"equals",value:function(e){if(this.position!==e.position)return!1;if(this.ranges.length!==e.ranges.length)return!1;for(var t=0;t<this.ranges.length;t++)if(!this.ranges[t].equals(e.ranges[t]))return!1;return!0}},{key:"somethingSelected",value:function(){for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].isEmpty())return!0;return!1}},{key:"compose",value:function(e){return e}},{key:"transform",value:function(t){for(var n=0,r=[];n<this.ranges.length;n++)r[n]=this.ranges[n].transform(t);return new e(r)}}]),e}();_(L,"Range",E),_(L,"createCursor",(function(e){return new L([new E(e,e)])})),_(L,"fromJSON",(function(e){for(var t=e.ranges||e,n=0,r=[];n<t.length;n++)r[n]=E.fromJSON(t[n]);return new L(r)}));var P=function(e,t){var n=i(t.split("\n")),r=(new u).retain(n);function i(e){if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n].length;return t+e.length-1}var o=function(e){for(var n=t.split("\n"),r=e.line,i=0,o=0;o<r;o++)i+=n[o].length;return i+=r+e.ch}(e.from),s=n-o-i(e.text.split("\n"));return r=(new u).retain(o).delete(e.deleteLength).insert(e.text).retain(s).compose(r)},T=function(e,t){for(var n=function(e){for(var n=0,r=0,i=0,o=t.split("\n"),s=0;s<o.length;s++){var a=o[s].length;if(i+a>=e){r=e-i;break}n++,i+=a+1}return{line:n,ch:r}},r=e.ops,i=[],o=0,s=0,a=r.length;s<a;s++){var c=r[s];if(u.isRetain(c))o+=c;else if(u.isInsert(c)){var l=n(o);i.push({from:{line:l.line,ch:l.ch},text:c,deleteLength:0}),o+=c.length;var f=t.slice(0,o),h=t.slice(o);t=f+c+h}else if(u.isDelete(c)){var p=n(o),v=n(o-c);i.push({from:{line:p.line,ch:p.ch},to:{line:v.line,ch:v.ch},deleteLength:-c,text:""});var y=t.slice(0,o),d=t.slice(o-c);t=y+d}}return i};function N(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var A=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),"/"!==t[t.length-1]&&(t+="/"),this.path=t,this.ownUserName=n,this.majorRevision=r.major||0,this.minorRevision=r.minor||0,this.poll()}var t,n,r;return t=e,(n=[{key:"renderRevisionPath",value:function(){return"revision/"+this.majorRevision+"-"+this.minorRevision}},{key:"handleResponse",value:function(e){var t,n=e.operations;for(t=0;t<n.length;t++)n[t].user===this.ownUserName?this.trigger("ack"):this.trigger("operation",n[t].operation);n.length>0&&(this.majorRevision+=n.length,this.minorRevision=0);var r=e.events;if(r){for(t=0;t<r.length;t++){var i=r[t].user;if(i!==this.ownUserName)switch(r[t].event){case"joined":this.trigger("set_name",i,i);break;case"left":this.trigger("client_left",i);break;case"selection":this.trigger("selection",i,r[t].selection)}}this.minorRevision+=r.length}var o=e.users;o&&(delete o[this.ownUserName],this.trigger("clients",o)),e.revision&&(this.majorRevision=e.revision.major,this.minorRevision=e.revision.minor)}},{key:"poll",value:function(){var e=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"GET",dataType:"json",timeout:5e3,success:function(t){e.handleResponse(t),e.poll()},error:function(){setTimeout((function(){e.poll()}),500)}})}},{key:"sendOperation",value:function(e,t,n){if(e!==this.majorRevision)throw new Error("Revision numbers out of sync");var r=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"POST",data:JSON.stringify({operation:t,selection:n}),contentType:"application/json",processData:!1,success:function(e){},error:function(){setTimeout((function(){r.sendOperation(e,t,n)}),500)}})}},{key:"sendSelection",value:function(e){$.ajax({url:this.path+this.renderRevisionPath()+"/selection",type:"POST",data:JSON.stringify(e),contentType:"application/json",processData:!1,timeout:1e3})}},{key:"registerCallbacks",value:function(e){this.callbacks=e}},{key:"trigger",value:function(e){var t=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[e];n&&n.apply(this,t)}}])&&N(t.prototype,n),r&&N(t,r),e}();function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function R(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function M(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function F(e,t,n){return t&&M(e.prototype,t),n&&M(e,n),e}var J=function(){function e(t){R(this,e),this.outstanding=t}return F(e,[{key:"applyClient",value:function(e,t){return new W(this.outstanding,t)}},{key:"applyServer",value:function(t,n,r){if(n-t.revision>1)throw new Error("Invalid revision.");t.revision=n;var i=r.constructor.transform(this.outstanding,r);return t.applyOperation(i[1]),new e(i[0])}},{key:"serverAck",value:function(e,t){return t-e.revision>1?new U(this.outstanding,e,t).getOperations():(e.revision=t,D)}},{key:"transformSelection",value:function(e){return e.transform(this.outstanding)}},{key:"resend",value:function(e){e.sendOperation(e.revision,this.outstanding)}}]),e}(),B=function(){function e(){R(this,e)}return F(e,[{key:"applyClient",value:function(e,t){return e.sendOperation(e.revision,t),new J(t)}},{key:"applyServer",value:function(e,t,n){if(t-e.revision>1)throw new Error("Invalid revision.");return e.revision=t,e.applyOperation(n),this}},{key:"serverAck",value:function(e,t){throw new Error("There is no pending operation.")}},{key:"transformSelection",value:function(e){return e}}]),e}(),D=new B,z=function(){function e(t,n,r,i){R(this,e),this.acknowlaged=t,this.buffer=n,this.client=r,this.revision=i}return F(e,[{key:"applyClient",value:function(t,n){var r=this.buffer.compose(n);return new e(this.acknowlaged,r,t,this.revision)}},{key:"applyServer",value:function(e,t,n){throw new Error("Ignored server-side change.")}},{key:"applyOperations",value:function(e,t,n){for(var r=this.acknowlaged.constructor.transform,i=0;i<n.length;i++){var o=ot.TextOperation.fromJSON(n[i]),s=r(this.acknowlaged,o),a=r(this.buffer,s[1]);e.applyOperation(a[1]),this.acknowlaged=s[0],this.buffer=a[0]}return e.revision=this.revision,e.sendOperation(e.revision,this.buffer),new J(this.buffer)}},{key:"serverAck",value:function(e,t){throw new Error("There is no pending operation.")}},{key:"transformSelection",value:function(e){return e}},{key:"getOperations",value:function(){return this.client.getOperations(this.client.revision,this.revision-1),this}}]),e}(),U=function(){function e(t,n,r){R(this,e),this.acknowlaged=t,this.client=n,this.revision=r}return F(e,[{key:"applyClient",value:function(e,t){return new z(this.acknowlaged,t,e,this.revision)}},{key:"applyServer",value:function(e,t,n){throw new Error("Ignored server-side change.")}},{key:"applyOperations",value:function(e,t,n){for(var r=this.acknowlaged.constructor.transform,i=0;i<n.length;i++){var o=ot.TextOperation.fromJSON(n[i]),s=r(this.acknowlaged,o);e.applyOperation(s[1]),this.acknowlaged=s[0]}return e.revision=this.revision,D}},{key:"serverAck",value:function(e,t){throw new Error("There is no pending operation.")}},{key:"transformSelection",value:function(e){return e}},{key:"getOperations",value:function(){return this.client.getOperations(this.client.revision,this.revision-1),this}}]),e}(),W=function(){function e(t,n){R(this,e),this.outstanding=t,this.buffer=n}return F(e,[{key:"applyClient",value:function(t,n){var r=this.buffer.compose(n);return new e(this.outstanding,r)}},{key:"applyServer",value:function(t,n,r){if(n-t.revision>1)throw new Error("Invalid revision.");t.revision=n;var i=r.constructor.transform,o=i(this.outstanding,r),s=i(this.buffer,o[1]);return t.applyOperation(s[1]),new e(o[0],s[0])}},{key:"serverAck",value:function(e,t){return t-e.revision>1?new z(this.outstanding,this.buffer,e,t).getOperations():(e.revision=t,e.sendOperation(e.revision,this.buffer),new J(this.buffer))}},{key:"transformSelection",value:function(e){return e.transform(this.outstanding).transform(this.buffer)}},{key:"resend",value:function(e){e.sendOperation(e.revision,this.outstanding)}}]),e}(),q=function(){function e(t){R(this,e),this.revision=t,this.setState(D)}return F(e,[{key:"setState",value:function(e){this.state=e}},{key:"applyClient",value:function(e){this.setState(this.state.applyClient(this,e))}},{key:"applyServer",value:function(e,t){this.setState(this.state.applyServer(this,e,t))}},{key:"applyOperations",value:function(e,t){this.setState(this.state.applyOperations(this,e,t))}},{key:"serverAck",value:function(e){this.setState(this.state.serverAck(this,e))}},{key:"serverReconnect",value:function(){"function"==typeof this.state.resend&&this.state.resend(this)}},{key:"transformSelection",value:function(e){return this.state.transformSelection(e)}},{key:"sendOperation",value:function(e,t){throw new Error("sendOperation must be defined in child class")}},{key:"applyOperation",value:function(e){throw new Error("applyOperation must be defined in child class")}}]),e}();function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}I(q,"Synchronized",B),I(q,"AwaitingConfirm",J),I(q,"AwaitingWithBuffer",W);var V=function(e,t){return function(e,t){return e.line<t.line?-1:e.line>t.line?1:e.ch<t.ch?-1:e.ch>t.ch?1:0}(e,t)<=0},K=function(e,t){var n=function(e){return e.indexFromPos({line:e.lastLine(),ch:0})+e.getLine(e.lastLine()).length}(t),r=(new u).retain(n),i=(new u).retain(n),o=function(e){return t.indexFromPos(e)};function s(e){if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n].length;return t+e.length-1}function a(e,t){return function(n){return V(n,t.from)?e(n):V(t.to,n)?e({line:n.line+t.text.length-1-(t.to.line-t.from.line),ch:t.to.line<n.line?n.ch:t.text.length<=1?n.ch-(t.to.ch-t.from.ch)+s(t.text):n.ch-t.to.ch+(r=t.text,r[r.length-1]).length})+s(t.removed)-s(t.text):t.from.line===n.line?e(t.from)+n.ch-t.from.ch:e(t.from)+s(t.removed.slice(0,n.line-t.from.line))+1+n.ch;var r}}for(var c=e.length-1;c>=0;c--){var l=e[c],f=(o=a(o,l))(l.from),h=n-f-s(l.text);r=(new u).retain(f).delete(s(l.removed)).insert(l.text.join("\n")).retain(h).compose(r),i=i.compose((new u).retain(f).delete(s(l.text)).insert(l.removed.join("\n")).retain(h)),n+=s(l.removed)-s(l.text)}return[r,i]},Z=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cm=t,this.ignoreNextChange=!1,this.changeInProgress=!1,this.selectionChanged=!1,this.addedStyle={},this.styleElement=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(this.styleElement),this.styleSheet=this.styleElement.sheet,this._bind(this,"onChanges"),this._bind(this,"onChange"),this._bind(this,"onCursorActivity"),this._bind(this,"onFocus"),this._bind(this,"onBlur"),t.on("changes",this.onChanges),t.on("change",this.onChange),t.on("cursorActivity",this.onCursorActivity),t.on("focus",this.onFocus),t.on("blur",this.onBlur)}var t,n,r;return t=e,(n=[{key:"detach",value:function(){this.cm.off("changes",this.onChanges),this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)}},{key:"registerCallbacks",value:function(e){this.callbacks=e}},{key:"onChange",value:function(){this.changeInProgress=!0}},{key:"onChanges",value:function(t,n){if(!this.ignoreNextChange){var r=e.operationFromCodeMirrorChanges(n,this.cm);this.trigger("change",r[0],r[1])}this.selectionChanged&&this.trigger("selectionChange"),this.changeInProgress=!1,this.ignoreNextChange=!1}},{key:"onFocus",value:function(){this.changeInProgress?this.selectionChanged=!0:this.trigger("selectionChange")}},{key:"onCursorActivity",value:function(){this.changeInProgress?this.selectionChanged=!0:this.trigger("selectionChange")}},{key:"onBlur",value:function(){this.cm.somethingSelected()||this.trigger("blur")}},{key:"getValue",value:function(){return this.cm.getValue()}},{key:"getSelection",value:function(){for(var e=this.cm,t=e.listSelections(),n=[],r=0;r<t.length;r++)n[r]=new L.Range(e.indexFromPos(t[r].anchor),e.indexFromPos(t[r].head));return new L(n)}},{key:"setSelection",value:function(e){for(var t=[],n=0;e&&n<e.ranges.length;n++){var r=e.ranges[n];t[n]={anchor:this.cm.posFromIndex(r.anchor),head:this.cm.posFromIndex(r.head)}}this.cm.setSelections(t)}},{key:"addStyleRule",value:function(e){this.addedStyle[e]||(this.addedStyle[e]=!0,this.styleSheet.insertRule(e,(this.styleSheet.cssRules||this.styleSheet.rules).length))}},{key:"setOtherCursor",value:function(e,t,n){var r=this.cm.posFromIndex(e),i=this.cm.cursorCoords(r),o=document.createElement("span");return o.className="other-client",o.style.display="inline-block",o.style.padding="0",o.style.marginLeft=o.style.marginRight="-1px",o.style.borderLeftWidth="2px",o.style.borderLeftStyle="solid",o.style.borderLeftColor=t,o.style.height=.9*(i.bottom-i.top)+"px",o.style.zIndex=0,o.setAttribute("data-clientid",n),this.cm.setBookmark(r,{widget:o,insertLeft:!0})}},{key:"setOtherSelectionRange",value:function(e,t,n){var r=/^#([0-9a-fA-F]{6})$/.exec(t);if(!r)throw new Error("only six-digit hex colors are allowed.");var i="selection-"+r[1],o=this._hex2rgb(t),s="."+i+" { background: rgba("+o.red+","+o.green+","+o.blue+",0.2); }";this.addStyleRule(s);var a,u,c=this.cm.posFromIndex(e.anchor),l=this.cm.posFromIndex(e.head);return this.cm.markText(V(a=c,u=l)?a:u,function(e,t){return V(e,t)?t:e}(c,l),{className:i})}},{key:"setOtherSelection",value:function(e,t,n){for(var r=[],i=0;i<e.ranges.length;i++){var o=e.ranges[i];o.isEmpty()?r[i]=this.setOtherCursor(o.head,t,n):r[i]=this.setOtherSelectionRange(o,t,n)}return{clear:function(){for(var e=0;e<r.length;e++)r[e]&&r[e].clear()}}}},{key:"trigger",value:function(e){var t=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[e];n&&n.apply(this,t)}},{key:"applyOperation",value:function(t){t.isNoop()||(this.ignoreNextChange=!0),e.applyOperationToCodeMirror(t,this.cm)}},{key:"registerUndo",value:function(e){this.cm.undo=e}},{key:"registerRedo",value:function(e){this.cm.redo=e}},{key:"_assert",value:function(e,t){if(!e)throw new Error(t||"assertion error")}},{key:"_bind",value:function(e,t){var n=e[t];e[t]=function(){n.apply(e,arguments)}}},{key:"_hex2rgb",value:function(e){if("#"===e[0]&&(e=e.substr(1)),3===e.length){var t=e;e="",t=/^([a-f0-9])([a-f0-9])([a-f0-9])$/i.exec(t).slice(1);for(var n=0;n<3;n++)e+=t[n]+t[n]}var r=/^([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/i.exec(e).slice(1);return{red:parseInt(r[0],16),green:parseInt(r[1],16),blue:parseInt(r[2],16)}}}])&&H(t.prototype,n),r&&H(t,r),e}();function Q(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}G(Z,"operationFromCodeMirrorChanges",K),G(Z,"operationFromCodeMirrorChange",K),G(Z,"applyOperationToCodeMirror",(function(e,t){t.operation((function(){for(var n=e.ops,r=0,i=0,o=n.length;i<o;i++){var s=n[i];if(u.isRetain(s))r+=s;else if(u.isInsert(s)){var a=t.getCursor(),c=t.posFromIndex(r);t.replaceRange(s,c,null,"ignoreHistory"),a.line===c.line&&a.ch===c.ch&&t.setCursor(a),r+=s.length}else if(u.isDelete(s)){var l=t.posFromIndex(r),f=t.posFromIndex(r-s);t.replaceRange("",l,f,"ignoreHistory")}}}))}));var X=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.socket=t;var n=this;t.on("client_left",(function(e){n.trigger("client_left",e)})).on("set_name",(function(e,t){n.trigger("set_name",e,t)})).on("set_color",(function(e,t){n.trigger("set_color",e,t)})).on("ack",(function(e){n.trigger("ack",e)})).on("operation",(function(e,t,r,i){n.trigger("operation",t,r),n.trigger("selection",e,i)})).on("operations",(function(e,t){n.trigger("operations",e,t)})).on("selection",(function(e,t){n.trigger("selection",e,t)})).on("reconnect",(function(){n.trigger("reconnect")}))}var t,n,r;return t=e,(n=[{key:"sendOperation",value:function(e,t,n){this.socket.emit("operation",e,t,n)}},{key:"sendSelection",value:function(e){this.socket.emit("selection",e)}},{key:"getOperations",value:function(e,t){this.socket.emit("get_operations",e,t)}},{key:"registerCallbacks",value:function(e){this.callbacks=e}},{key:"trigger",value:function(e){var t=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[e];n&&n.apply(this,t)}}])&&Q(t.prototype,n),r&&Q(t,r),e}();function Y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ee=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.maxItems=t||50,this.state="normal",this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}var t,n,r;return t=e,(n=[{key:"add",value:function(e,t){if("undoing"===this.state)this.redoStack.push(e),this.dontCompose=!0;else if("redoing"===this.state)this.undoStack.push(e),this.dontCompose=!0;else{var n=this.undoStack;!this.dontCompose&&t&&n.length>0?n.push(e.compose(n.pop())):(n.push(e),n.length>this.maxItems&&n.shift()),this.dontCompose=!1,this.redoStack=[]}}},{key:"_transformStack",value:function(e,t){for(var n=[],r=t.constructor,i=e.length-1;i>=0;i--){var o=r.transform(e[i],t);"function"==typeof o[0].isNoop&&o[0].isNoop()||n.push(o[0]),t=o[1]}return n.reverse()}},{key:"transform",value:function(e){this.undoStack=this._transformStack(this.undoStack,e),this.redoStack=this._transformStack(this.redoStack,e)}},{key:"performUndo",value:function(e){if(this.state="undoing",0===this.undoStack.length)throw new Error("undo not possible");e(this.undoStack.pop()),this.state="normal"}},{key:"performRedo",value:function(e){if(this.state="redoing",0===this.redoStack.length)throw new Error("redo not possible");e(this.redoStack.pop()),this.state="normal"}},{key:"canUndo",value:function(){return 0!==this.undoStack.length}},{key:"canRedo",value:function(){return 0!==this.redoStack.length}},{key:"isUndoing",value:function(){return"undoing"===this.state}},{key:"isRedoing",value:function(){return"redoing"===this.state}}])&&Y(t.prototype,n),r&&Y(t,r),e}();function te(e){return(te="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ne(e){return(ne=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function re(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ie(e,t){return(ie=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function oe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function se(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ae(e,t,n){return t&&se(e.prototype,t),n&&se(e,n),e}var ue=function(){function e(t,n,r,i,o,s){oe(this,e),this.id=t,this.listEl=n,this.editorAdapter=r,this.name=i,this.color=o,this.li=document.createElement("li"),i&&(this.li.textContent=i,this.listEl.appendChild(this.li)),o?this.setForceColor(o):this.setColor(i?this._hueFromName(i):Math.random()),s&&this.updateSelection(s)}return ae(e,[{key:"setColor",value:function(e){this.hue=e,this.color=this._hsl2hex(e,.75,.5),this.lightColor=this._hsl2hex(e,.5,.9),this.li&&(this.li.style.color=this.color)}},{key:"setForceColor",value:function(e){this.hue=null,this.color=e,this.lightColor=e,this.li&&(this.li.style.color=this.color)}},{key:"setName",value:function(e){this.name!==e&&(this.name=e,this.li.textContent=e,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(this._hueFromName(e)))}},{key:"updateSelection",value:function(e){this.removeSelection(),this.selection=e,this.mark=this.editorAdapter.setOtherSelection(e,e.position===e.selectionEnd?this.color:this.lightColor,this.id)}},{key:"remove",value:function(){this.li&&this._removeElement(this.li),this.removeSelection()}},{key:"removeSelection",value:function(){this.mark&&(this.mark.clear(),this.mark=null)}},{key:"_rgb2hex",value:function(e,t,n){function r(e){var t=Math.round(255*e).toString(16);return 1===t.length?"0"+t:t}return"#"+r(e)+r(t)+r(n)}},{key:"_hsl2hex",value:function(e,t,n){if(0===t)return this._rgb2hex(n,n,n);var r=n<.5?n*(1+t):n+t-t*n,i=2*n-r,o=function(e){return e<0&&(e+=1),e>1&&(e-=1),6*e<1?i+6*(r-i)*e:2*e<1?r:3*e<2?i+6*(r-i)*(2/3-e):i};return this._rgb2hex(o(e+1/3),o(e),o(e-1/3))}},{key:"_hueFromName",value:function(e){for(var t=1,n=0;n<e.length;n++)t=17*(t+e.charCodeAt(n))%360;return t/360}},{key:"_removeElement",value:function(e){e.parentNode&&e.parentNode.removeChild(e)}}]),e}(),ce=function(){function e(t,n){oe(this,e),this.clientId=t,this.selection=n}return ae(e,[{key:"transform",value:function(t){return new e(this.clientId,this.selection&&this.selection.transform(t))}}]),e}();!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(ce,"fromJSON",(function(e){return new ce(e.clientId,e.selection&&L.fromJSON(e.selection))}));var le=function(){function e(t,n){oe(this,e),this.selectionBefore=t,this.selectionAfter=n}return ae(e,[{key:"invert",value:function(){return new e(this.selectionAfter,this.selectionBefore)}},{key:"compose",value:function(t){return new e(this.selectionBefore,t.selectionAfter)}},{key:"transform",value:function(t){return new e(this.selectionBefore?this.selectionBefore.transform(t):null,this.selectionAfter?this.selectionAfter.transform(t):null)}}]),e}(),fe=function(e){function t(e,n,r,i){var o;oe(this,t),(o=function(e,t){return!t||"object"!==te(t)&&"function"!=typeof t?re(e):t}(this,ne(t).call(this,e))).serverAdapter=r,o.editorAdapter=i,o.undoManager=new ee,o.initializeClientList(),o.initializeClients(n);var s=re(o);return o.editorAdapter.registerCallbacks({change:function(e,t){s.onChange(e,t)},selectionChange:function(){s.onSelectionChange()},blur:function(){s.onBlur()}}),o.editorAdapter.registerUndo((function(){s.undo()})),o.editorAdapter.registerRedo((function(){s.redo()})),o.serverAdapter.registerCallbacks({client_left:function(e){s.onClientLeft(e)},set_name:function(e,t){s.getClientObject(e).setName(t)},set_color:function(e,t){s.getClientObject(e).setForceColor(t)},ack:function(e){s.serverAck(e)},operation:function(e,t){s.applyServer(e,u.fromJSON(t))},operations:function(e,t){s.applyOperations(e,t)},selection:function(e,t){t?s.getClientObject(e).updateSelection(s.transformSelection(L.fromJSON(t))):s.getClientObject(e).removeSelection()},clients:function(e){var t;for(t in s.clients)s.clients.hasOwnProperty(t)&&!e.hasOwnProperty(t)&&s.onClientLeft(t);for(t in e)if(e.hasOwnProperty(t)){var n=s.getClientObject(t);e[t].name&&n.setName(e[t].name);var r=e[t].selection;r?s.clients[t].updateSelection(s.transformSelection(L.fromJSON(r))):s.clients[t].removeSelection()}},reconnect:function(){s.serverReconnect()}}),o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ie(e,t)}(t,e),ae(t,[{key:"addClient",value:function(e,t){this.clients[e]=new ue(e,this.clientListEl,this.editorAdapter,t.name||e,t.color||null,t.selection?L.fromJSON(t.selection):null)}},{key:"initializeClients",value:function(e){for(var t in this.clients={},e)e.hasOwnProperty(t)&&this.addClient(t,e[t])}},{key:"getClientObject",value:function(e){var t=this.clients[e];return t||(this.clients[e]=new ue(e,this.clientListEl,this.editorAdapter))}},{key:"onClientLeft",value:function(e){var t=this.clients[e];t&&(t.remove(),delete this.clients[e])}},{key:"initializeClientList",value:function(){this.clientListEl=document.createElement("ul")}},{key:"applyUnredo",value:function(e){this.undoManager.add(e.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(e.wrapped),this.selection=e.meta.selectionAfter,this.editorAdapter.setSelection(this.selection),this.applyClient(e.wrapped)}},{key:"undo",value:function(){var e=this;this.undoManager.canUndo()&&this.undoManager.performUndo((function(t){e.applyUnredo(t)}))}},{key:"redo",value:function(){var e=this;this.undoManager.canRedo()&&this.undoManager.performRedo((function(t){e.applyUnredo(t)}))}},{key:"onChange",value:function(e,t){var n=this.selection;this.updateSelection();var r=new le(n,this.selection),i=(new S(e,r),this.undoManager.undoStack.length>0&&t.shouldBeComposedWithInverted(this._last(this.undoManager.undoStack).wrapped)),o=new le(this.selection,n);this.undoManager.add(new S(t,o),i),this.applyClient(e)}},{key:"updateSelection",value:function(){this.selection=this.editorAdapter.getSelection()}},{key:"onSelectionChange",value:function(){var e=this.selection;this.updateSelection(),e&&this.selection.equals(e)||this.sendSelection(this.selection)}},{key:"onBlur",value:function(){this.selection=null,this.sendSelection(null)}},{key:"sendSelection",value:function(e){this.state instanceof q.AwaitingWithBuffer||this.serverAdapter.sendSelection(e)}},{key:"sendOperation",value:function(e,t){this.serverAdapter.sendOperation(e,t.toJSON(),this.selection)}},{key:"getOperations",value:function(e,t){this.serverAdapter.getOperations(e,t)}},{key:"applyOperation",value:function(e){this.editorAdapter.applyOperation(e),this.updateSelection(),this.undoManager.transform(new S(e,null))}},{key:"_last",value:function(e){return e[e.length-1]}}]),t}(q),he=n(0);function pe(e){return(pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ve(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ye(e,t){return!t||"object"!==pe(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function de(e){return(de=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ge(e,t){return(ge=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var me=function(e){function t(e,n){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(r=ye(this,de(t).call(this))).document=e,r.operations=n||[],r.setDocumentMaxLength(null),r}var n,r,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ge(e,t)}(t,e),n=t,(r=[{key:"setDocumentMaxLength",value:function(e){this.documentMaxLength=e}},{key:"receiveOperation",value:function(e,t){if(e<0||this.operations.length<e)throw new Error("operation revision not in history");for(var n=this.operations.slice(e),r=t.constructor.transform,i=0;i<n.length;i++)t=r(t,n[i])[0];var o=t.apply(this.document);if(!("number"==typeof this.documentMaxLength&&o.length>this.documentMaxLength&&o.length>this.document.length))return this.document=o,this.operations.push(t),t}}])&&ve(n.prototype,r),i&&ve(n,i),t}(n.n(he).a);n(1);function be(e){return(be="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function we(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ke(e,t){return!t||"object"!==be(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Oe(e){return(Oe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Se(e,t){return(Se=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ce=function(e){function t(e,n,r,i,o){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(s=ke(this,Oe(t).call(this,e,n))).users={},s.docId=r,s.mayWrite=i||function(e,t){t(!0)},s.operationCallback=o,s.isBusy=!1,s.logger={info:function(){},error:function(){},debug:function(){}},s.debug=!1,s}var n,r,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Se(e,t)}(t,e),n=t,(r=[{key:"setLogger",value:function(e){this.logger=e}},{key:"debugLog",value:function(e){this.debug&&this.logger.debug(e)}},{key:"addClient",value:function(e){var t=this;e.join(this.docId).emit("doc",{str:this.document,revision:this.operations.length,clients:this.users}).on("operation",(function(n,r,i){t.isBusy=!0,e.origin="operation",t.mayWrite(e,(function(o){if(o)try{var s=t.onOperation(e,n,r,i);s&&(t.debugLog("new operation: "+JSON.stringify(s)),"function"==typeof t.operationCallback?t.operationCallback(e,s,(function(){t.isBusy=!1})):t.isBusy=!1)}catch(n){t.logger.error(n),setTimeout((function(){e.emit("doc",{str:t.document,revision:t.operations.length,clients:t.users,force:!0})}),100),t.isBusy=!1}else t.debugLog("User doesn't have the right to edit.")}))})).on("get_operations",(function(n,r){t.onGetOperations(e,n,r)})).on("selection",(function(n){e.origin="selection",t.mayWrite(e,(function(r){r?t.updateSelection(e,n&&L.fromJSON(n)):t.debugLog("User doesn't have the right to edit.")}))})).on("disconnect",(function(){t.debugLog("Disconnect"),e.leave(t.docId),t.onDisconnect(e)}))}},{key:"onOperation",value:function(e,t,n,r){var i;try{i=new S(u.fromJSON(n),r&&L.fromJSON(r))}catch(e){throw this.logger.error("Invalid operation received: "),new Error(e)}try{var o=e.id,s=this.receiveOperation(t,i);if(!s)return;return this.getClient(o).selection=s.meta,t=this.operations.length,e.emit("ack",t),e.broadcast.to(this.docId).emit("operation",o,t,s.wrapped.toJSON(),s.meta),s.wrapped.toJSON()}catch(e){throw new Error(e)}}},{key:"onGetOperations",value:function(e,t,n){var r=this.operations.slice(t,n).map((function(e){return e.wrapped.toJSON()}));e.emit("operations",n,r)}},{key:"updateSelection",value:function(e,t){var n=e.id;t?this.getClient(n).selection=t:delete this.getClient(n).selection,e.broadcast.to(this.docId).emit("selection",n,t)}},{key:"setName",value:function(e,t){var n=e.id;this.getClient(n).name=t,e.broadcast.to(this.docId).emit("set_name",n,t)}},{key:"setColor",value:function(e,t){var n=e.id;this.getClient(n).color=t,e.broadcast.to(this.docId).emit("set_color",n,t)}},{key:"getClient",value:function(e){return this.users[e]||(this.users[e]={})}},{key:"onDisconnect",value:function(e){var t=e.id;delete this.users[t],e.broadcast.to(this.docId).emit("client_left",t)}}])&&we(n.prototype,r),i&&we(n,i),t}(me);t.default={TextOperation:u,SimpleTextOperation:g,WrappedOperation:S,Selection:L,toOperation:P,fromOperation:T,AjaxAdapter:A,Client:q,CodeMirrorAdapter:Z,SocketIOAdapter:X,EditorClient:fe,UndoManager:ee,Server:me,EditorSocketIOServer:Ce}}])}));